<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Jellio</title>
    <style>
        .addon-urls {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        .addon-url-item {
            margin: 10px 0;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }
        .addon-url-item strong {
            display: block;
            margin-bottom: 5px;
            color: #00a4dc;
        }
        .addon-url-item code {
            display: block;
            padding: 8px;
            background: rgba(0,0,0,0.4);
            border-radius: 3px;
            font-family: monospace;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div id="configPage" data-role="page" class="page type-interior pluginConfigurationPage configPage" data-require="emby-button">
        <div data-role="content">
            <div class="content-primary">
                <h1>Jellio - Jellyfin to Stremio Bridge</h1>
                <p>Configure your Stremio addon URLs below. Copy the URL for your selected library and paste it into Stremio's addon configuration.</p>
                
                <form class="configForm">
                    <div class="addon-urls">
                        <h2>Stremio Addon URLs</h2>
                        <p id="loading">Loading libraries...</p>
                        <div id="addonUrlList"></div>
                    </div>
                    <br />
                    <div>
                        <button is="emby-button" type="button" class="raised button-submit block" onclick="window.location.reload()">
                            <span>Refresh</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var PluginConfig = {
                pluginId: "e874be83-fe36-4568-abac-f5ce0574b409"
            };

            document.querySelector('.configPage')
                .addEventListener('pageshow', async function () {
                    Dashboard.showLoadingMsg();
                    
                    try {
                        // Get server info and libraries using the backend API
                        // ApiClient is automatically authenticated in Jellyfin's web UI context
                        const response = await fetch('/jellio/server-info', {
                            headers: {
                                'X-Emby-Token': ApiClient.accessToken()
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error('Failed to fetch server info');
                        }
                        
                        const data = await response.json();
                        const serverName = data.name;
                        const libraries = data.libraries;
                        
                        // Hide loading message
                        document.querySelector('#loading').style.display = 'none';
                        
                        // Generate addon URLs
                        const baseUrl = window.location.origin;
                        const addonListEl = document.querySelector('#addonUrlList');
                        
                        if (libraries.length === 0) {
                            addonListEl.innerHTML = '<p>No libraries found. Please ensure you have media libraries configured.</p>';
                        } else {
                            addonListEl.innerHTML = libraries.map(lib => {
                                const addonUrl = `${baseUrl}/jellio/addon/${encodeURIComponent(lib.Id)}/manifest.json`;
                                return `
                                    <div class="addon-url-item">
                                        <strong>${lib.Name} (${lib.CollectionType || 'mixed'})</strong>
                                        <code>${addonUrl}</code>
                                    </div>
                                `;
                            }).join('');
                        }
                        
                        Dashboard.hideLoadingMsg();
                    } catch (error) {
                        console.error('Error loading configuration:', error);
                        document.querySelector('#loading').textContent = 'Error loading libraries: ' + error.message;
                        Dashboard.hideLoadingMsg();
                    }
                });
        </script>
    </div>
</body>
</html>
